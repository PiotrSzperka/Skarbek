name: Deploy to Proxmox

on:
  workflow_dispatch:
    inputs:
      pull_images:
        description: "Run docker compose pull before restarting?"
        type: boolean
        default: true

jobs:
  deploy:
    name: Deploy via Docker Compose
    runs-on:
      - self-hosted
      - docker
    environment: production
    steps:
      - name: Validate secrets
        env:
          PROXMOX_ENV_FILE: ${{ secrets.PROXMOX_ENV_FILE }}
          DEPLOY_POSTGRES_PASSWORD: ${{ secrets.DEPLOY_POSTGRES_PASSWORD }}
          DEPLOY_ADMIN_PASSWORD: ${{ secrets.DEPLOY_ADMIN_PASSWORD }}
          DEPLOY_JWT_SECRET: ${{ secrets.DEPLOY_JWT_SECRET }}
        run: |
          if [ -n "$PROXMOX_ENV_FILE" ]; then
            exit 0
          fi

          missing=0

          if [ -z "$DEPLOY_POSTGRES_PASSWORD" ]; then
            echo "Secret DEPLOY_POSTGRES_PASSWORD is required when PROXMOX_ENV_FILE is unset."
            missing=1
          fi

          if [ -z "$DEPLOY_ADMIN_PASSWORD" ]; then
            echo "Secret DEPLOY_ADMIN_PASSWORD is required when PROXMOX_ENV_FILE is unset."
            missing=1
          fi

          if [ -z "$DEPLOY_JWT_SECRET" ]; then
            echo "Secret DEPLOY_JWT_SECRET is required when PROXMOX_ENV_FILE is unset."
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build deployment .env file
        env:
          PROXMOX_ENV_FILE: ${{ secrets.PROXMOX_ENV_FILE }}
          DEPLOY_BACKEND_IMAGE: ${{ secrets.DEPLOY_BACKEND_IMAGE }}
          DEPLOY_FRONTEND_IMAGE: ${{ secrets.DEPLOY_FRONTEND_IMAGE }}
          DEPLOY_BACKEND_HOST_PORT: ${{ secrets.DEPLOY_BACKEND_HOST_PORT }}
          DEPLOY_FRONTEND_HOST_PORT: ${{ secrets.DEPLOY_FRONTEND_HOST_PORT }}
          DEPLOY_POSTGRES_USER: ${{ secrets.DEPLOY_POSTGRES_USER }}
          DEPLOY_POSTGRES_PASSWORD: ${{ secrets.DEPLOY_POSTGRES_PASSWORD }}
          DEPLOY_POSTGRES_DB: ${{ secrets.DEPLOY_POSTGRES_DB }}
          DEPLOY_ADMIN_USER: ${{ secrets.DEPLOY_ADMIN_USER }}
          DEPLOY_ADMIN_PASSWORD: ${{ secrets.DEPLOY_ADMIN_PASSWORD }}
          DEPLOY_JWT_SECRET: ${{ secrets.DEPLOY_JWT_SECRET }}
          FRONTEND_URL: ${{ vars.FRONTEND_URL }}
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
          GMAIL_SENDER_EMAIL: ${{ secrets.GMAIL_SENDER_EMAIL }}
        run: |
          set -euo pipefail

          if [ -n "$PROXMOX_ENV_FILE" ]; then
            printf "%s" "$PROXMOX_ENV_FILE" > deploy/proxmox/.env
            exit 0
          fi

          BACKEND_IMAGE="${DEPLOY_BACKEND_IMAGE:-peterszp/skarbek-backend:latest}"
          FRONTEND_IMAGE="${DEPLOY_FRONTEND_IMAGE:-peterszp/skarbek-frontend:latest}"
          BACKEND_HOST_PORT="${DEPLOY_BACKEND_HOST_PORT:-8000}"
          FRONTEND_HOST_PORT="${DEPLOY_FRONTEND_HOST_PORT:-3000}"
          POSTGRES_USER="${DEPLOY_POSTGRES_USER:-skarbek}"
          POSTGRES_DB="${DEPLOY_POSTGRES_DB:-skarbek}"
          ADMIN_USER="${DEPLOY_ADMIN_USER:-admin}"

          {
            printf 'BACKEND_IMAGE=%s\n' "$BACKEND_IMAGE"
            printf 'FRONTEND_IMAGE=%s\n' "$FRONTEND_IMAGE"
            printf 'BACKEND_HOST_PORT=%s\n' "$BACKEND_HOST_PORT"
            printf 'FRONTEND_HOST_PORT=%s\n' "$FRONTEND_HOST_PORT"
            printf 'POSTGRES_USER=%s\n' "$POSTGRES_USER"
            printf 'POSTGRES_PASSWORD=%s\n' "$DEPLOY_POSTGRES_PASSWORD"
            printf 'POSTGRES_DB=%s\n' "$POSTGRES_DB"
            printf 'ADMIN_USER=%s\n' "$ADMIN_USER"
            printf 'ADMIN_PASSWORD=%s\n' "$DEPLOY_ADMIN_PASSWORD"
            printf 'JWT_SECRET=%s\n' "$DEPLOY_JWT_SECRET"
            if [ -n "$FRONTEND_URL" ]; then
              printf 'FRONTEND_URL=%s\n' "$FRONTEND_URL"
            fi
            if [ -n "$GMAIL_CLIENT_ID" ]; then
              printf 'GMAIL_CLIENT_ID=%s\n' "$GMAIL_CLIENT_ID"
            fi
            if [ -n "$GMAIL_CLIENT_SECRET" ]; then
              printf 'GMAIL_CLIENT_SECRET=%s\n' "$GMAIL_CLIENT_SECRET"
            fi
            if [ -n "$GMAIL_REFRESH_TOKEN" ]; then
              printf 'GMAIL_REFRESH_TOKEN=%s\n' "$GMAIL_REFRESH_TOKEN"
            fi
            if [ -n "$GMAIL_SENDER_EMAIL" ]; then
              printf 'GMAIL_SENDER_EMAIL=%s\n' "$GMAIL_SENDER_EMAIL"
            fi
          } > deploy/proxmox/.env

      - name: Deploy stack
        working-directory: deploy/proxmox
        env:
          PULL_IMAGES: ${{ github.event.inputs.pull_images }}
        run: |
          set -euo pipefail
          if [ "${PULL_IMAGES}" = "true" ]; then
            docker compose pull
          fi
          docker compose up -d
          docker compose ps

      - name: Run database migrations
        working-directory: deploy/proxmox
        run: |
          set -euo pipefail
          echo "‚è≥ Waiting for backend container to be healthy..."
          sleep 5
          
          echo "üöÄ Running database migrations..."
          docker compose exec -T backend python run_migrations.py
          
          echo "‚úÖ Migrations completed successfully"